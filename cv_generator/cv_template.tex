import streamlit as st
import fitz  # PyMuPDF
import os
import subprocess
import json
import google.generativeai as genai
from jinja2 import Environment, FileSystemLoader

# --- CONFIGURATION ---
TEMPLATE_FILE = "cv_template.tex"
BUILD_DIR = "build"
os.makedirs(BUILD_DIR, exist_ok=True)

# --- JINJA2 SETUP ---
env = Environment(
    loader=FileSystemLoader('.'),
    block_start_string='\BLOCK{',
    block_end_string='}',
    variable_start_string='\VAR{',
    variable_end_string='}',
    comment_start_string='\#{',
    comment_end_string='}',
    trim_blocks=True,
    autoescape=False,
)

# --- FUNCTIONS ---
def extract_text_from_pdf(uploaded_file):
    doc = fitz.open(stream=uploaded_file.read(), filetype="pdf")
    text = ""
    for page in doc:
        text += page.get_text()
    return text

def get_ai_data(api_key, raw_text):
    genai.configure(api_key=api_key)
    model = genai.GenerativeModel('gemini-1.5-flash')
    
    prompt = f"""
    Act as a professional resume writer. Extract data from the text below and return strict JSON.
    Clean up messy text. Summarize job descriptions into 2-3 high-impact bullet points.
    
    JSON Structure:
    {{
        "name": "Full Name",
        "title": "Current Job Title",
        "email": "Email Address",
        "phone": "Phone Number",
        "linkedin": "LinkedIn URL",
        "portfolio": "Portfolio/GitHub URL",
        "summary": "3-4 line professional summary",
        "skills_hard": "List of hard skills",
        "skills_tools": "List of tools",
        "skills_soft": "List of soft skills",
        "experience": [ {{ "role": "...", "company": "...", "dates": "...", "bullets": ["...", "..."] }} ],
        "education": [ {{ "degree": "...", "institution": "...", "year": "...", "grade": "..." }} ],
        "projects": [ {{ "name": "...", "description": "..." }} ]
    }}

    RAW TEXT:
    {raw_text}
    """
    response = model.generate_content(prompt, generation_config={"response_mime_type": "application/json"})
    return json.loads(response.text)

def compile_latex(data, photo_path=None):
    # Logic: Tell LaTeX if we have a photo or not
    if photo_path and os.path.exists(photo_path):
        data['show_photo'] = True
        data['photo_path'] = photo_path
    else:
        data['show_photo'] = False
        data['photo_path'] = ""

    template = env.get_template(TEMPLATE_FILE)
    latex_content = template.render(data)

    tex_path = os.path.join(BUILD_DIR, "resume.tex")
    with open(tex_path, "w") as f:
        f.write(latex_content)

    try:
        # Run twice for layout alignment
        subprocess.run(["pdflatex", "-output-directory", BUILD_DIR, "-interaction=nonstopmode", tex_path], check=True)
    except subprocess.CalledProcessError:
        st.error("LaTeX compilation failed. Ensure the server has 'texlive' installed.")
        return None

    return os.path.join(BUILD_DIR, "resume.pdf")

# --- UI LAYOUT ---
st.set_page_config(page_title="AI CV Generator", layout="wide")
st.title("üìÑ Instant CV Standardizer")

# Sidebar
with st.sidebar:
    st.header("Settings")
    api_key = st.text_input("Gemini API Key", type="password")
    st.info("üí° Note: Initial startup might be slow as the server installs PDF tools.")

# Main Input Area
col1, col2 = st.columns([1, 1])

with col1:
    st.subheader("1. Upload Documents")
    uploaded_cv = st.file_uploader("Drop your CV here (PDF)", type=["pdf"])
    
    st.markdown("---")
    st.write(" **Photo Options**")
    uploaded_photo = st.file_uploader("Drop Photo here (Optional)", type=["jpg", "jpeg", "png"])
    
    # "Paste" isn't natively supported for files in browsers yet, 
    # but Drag & Drop works for images copied to desktop.

with col2:
    st.subheader("2. Generate")
    if uploaded_cv and api_key:
        if st.button("üöÄ Process and Generate PDF", type="primary"):
            with st.status("Processing...", expanded=True) as status:
                
                # 1. Extract
                st.write("Reading PDF text...")
                raw_text = extract_text_from_pdf(uploaded_cv)
                
                # 2. AI Analysis
                st.write("Extracting details with AI...")
                try:
                    cv_data = get_ai_data(api_key, raw_text)
                except Exception as e:
                    st.error(f"AI Error: {e}")
                    st.stop()
                
                # 3. Handle Photo
                photo_filename = None
                if uploaded_photo:
                    photo_filename = "user_photo.jpg"
                    photo_path = os.path.join(BUILD_DIR, photo_filename)
                    with open(photo_path, "wb") as f:
                        f.write(uploaded_photo.getbuffer())
                    st.write("Photo processed.")
                else:
                    st.write("No photo provided. Generating text-only header.")

                # 4. Compile
                st.write("Compiling PDF (this may take 10-20s)...")
                pdf_path = compile_latex(cv_data, photo_filename)
                
                if pdf_path:
                    status.update(label="Complete!", state="complete", expanded=False)
                    st.success("CV Generated Successfully!")
                    
                    # Preview & Download
                    with open(pdf_path, "rb") as f:
                        st.download_button(
                            label="‚¨áÔ∏è Download PDF",
                            data=f,
                            file_name=f"Standardized_CV_{cv_data.get('name', 'User')}.pdf",
                            mime="application/pdf"
                        )
                else:
                    status.update(label="Failed", state="error")

    elif not api_key:
        st.warning("Please enter your API Key in the sidebar.")
